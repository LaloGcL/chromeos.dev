---
import Article from '$layouts/article.astro';
import TOC from '$components/TOC.svelte';
import { renderMarkdown } from '$$markdown';

/**
 * Builds paths for content files
 */
export async function getStaticPaths() {
  const articles = await Astro.glob('../../markdown/**/*.md');
  console.log(articles[0].file);

  const all = await Promise.all(
    articles.map(async (article) => {
      const path = article.file.replace(/.*\/markdown\/(.*)\.md/, '$1');

      const lang = path.split('/')[0];
      let slug = path.split('/').slice(1).join('/');
      if (slug.endsWith('/index')) {
        slug = slug.replace(/\/index$/, '');
      }
      const section = slug.split('/')[0];
      const { content, toc } = await renderMarkdown(article.rawContent());

      article.frontmatter.date = new Date(article.frontmatter.date);
      return {
        params: {
          lang,
          path: slug,
        },
        props: {
          content,
          toc,
          meta: article.frontmatter,
          section,
        },
      };
    }),
  );
  return all.filter(
    (article) =>
      article.props.section !== 'posts' && article.props.section !== 'stories',
  );
}

const { lang } = Astro.params;
const { content, meta, section, toc } = Astro.props;

const locale = {
  code: lang,
  dir: 'ltr',
};
---

<Article
  title={meta.title}
  locale={locale}
  metadesc={meta.metadesc}
  section={section}
>
  <!-- Subnav Sidebar -->
  <!-- Main content area -->
  <Fragment slot="content" set:html={content} />
  <!-- Extras sidegar -->
  <Fragment slot="extras">
    <TOC toc={toc} client:load />
  </Fragment>
</Article>
